name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # ---------------------------------------------------------------------------
  # Tier 1: Lint (advisory, non-blocking)
  # ---------------------------------------------------------------------------
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build project (needed for static analysis)
        run: mvn install -DskipTests -B -q

      - name: Checkstyle
        run: mvn checkstyle:check -B

      - name: SpotBugs
        run: mvn spotbugs:check -B

      - name: PMD
        run: mvn pmd:check -B

      - name: Ruff (Python)
        run: |
          pip install ruff
          ruff check tests/ scripts/

      - name: Upload lint reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-reports
          path: '**/target/checkstyle-result.xml'
          retention-days: 7

  # ---------------------------------------------------------------------------
  # Tier 1: Build (relaxed mode, no extension)
  # ---------------------------------------------------------------------------
  build-relaxed:
    name: Build (relaxed)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build server JAR
        run: mvn clean package -DskipTests -B

      - name: Upload server JAR
        uses: actions/upload-artifact@v4
        with:
          name: thunderduck-server
          path: connect-server/target/thunderduck-connect-server-*.jar
          retention-days: 1

  # ---------------------------------------------------------------------------
  # Tier 1: Build (strict mode, with DuckDB extension)
  # ---------------------------------------------------------------------------
  build-strict:
    name: Build (strict)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize submodules
        run: |
          # Remove the extraheader that actions/checkout sets â€” it blocks
          # anonymous HTTPS access to public nested submodules (duckdb/duckdb)
          git config --unset-all http.https://github.com/.extraheader || true
          git submodule update --init --recursive

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Install C++ build tools
        run: sudo apt-get update && sudo apt-get install -y cmake ninja-build g++

      - name: Cache DuckDB extension build
        uses: actions/cache@v4
        with:
          path: thunderduck-duckdb-extension/build/release/
          key: duckdb-extension-${{ runner.os }}-${{ hashFiles('thunderduck-duckdb-extension/duckdb/CMakeLists.txt', 'thunderduck-duckdb-extension/extension_config.cmake', 'thunderduck-duckdb-extension/src/**') }}
          restore-keys: |
            duckdb-extension-${{ runner.os }}-

      - name: Build with extension
        env:
          CMAKE_BUILD_PARALLEL_LEVEL: 2
        run: mvn clean package -DskipTests -B -Pbuild-extension

      - name: Upload server JAR (strict)
        uses: actions/upload-artifact@v4
        with:
          name: thunderduck-server-strict
          path: connect-server/target/thunderduck-connect-server-*.jar
          retention-days: 1

  # ---------------------------------------------------------------------------
  # Tier 2: Java unit tests
  # ---------------------------------------------------------------------------
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: build-relaxed
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Install modules and run tests
        run: |
          mvn install -DskipTests -B -q
          mvn test -B -pl tests

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: tests/target/surefire-reports/
          retention-days: 2

  # ---------------------------------------------------------------------------
  # Tier 2: Integration tests (TPC-H differential, 51 tests)
  # ---------------------------------------------------------------------------
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build-relaxed
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download server JAR
        uses: actions/download-artifact@v4
        with:
          name: thunderduck-server
          path: connect-server/target/

      - name: Cache Apache Spark distribution
        uses: actions/cache@v4
        with:
          path: ~/spark/spark-4.1.1
          key: spark-4.1.1-bin-hadoop3

      - name: Download Apache Spark 4.1.1
        run: |
          if [ ! -f ~/spark/spark-4.1.1/bin/spark-submit ]; then
            mkdir -p ~/spark
            curl -fsSL https://dlcdn.apache.org/spark/spark-4.1.1/spark-4.1.1-bin-hadoop3.tgz \
              | tar -xz -C ~/spark
            mv ~/spark/spark-4.1.1-bin-hadoop3 ~/spark/spark-4.1.1
          fi

      - name: Install Python dependencies
        run: pip install -r tests/integration/requirements.txt

      - name: Run TPC-H differential tests
        env:
          SPARK_HOME: ~/spark/spark-4.1.1
        run: ./tests/scripts/run-differential-tests-v2.sh --ci tpch
